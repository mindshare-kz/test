<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mindshare Auth</title>
<style>
body {
  font-family: sans-serif;
  text-align: center;
  margin: 0;
  padding: 50px;
  background: #f0f0f0;
}
input {
  padding: 10px;
  font-size: 16px;
  margin: 10px 0;
  width: 250px;
}
button {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}
#message {
  margin-top: 20px;
  font-weight: bold;
}
</style>
</head>
<body>
  <main>
    <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <input type="text" id="login" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
    <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>

    <div id="passwordSection" style="display:none;">
      <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
      <button id="submitBtn">–í–æ–π—Ç–∏</button>
    </div>

    <p id="message"></p>
  </main>

  <!-- –°–∫—Ä—ã—Ç—ã–π iframe –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS -->
  <iframe id="authFrame" style="display:none;"></iframe>

<script>
const AUTH_URL = "https://script.google.com/macros/s/AKfycbzoLLnfmrwnVpXpVkPNLd7Hs-jKyfBudJExqW-7FCdhYtbhsfgcuPZ106Z_TIbfv4g5Zw/exec";

const loginInput = document.getElementById("login");
const checkBtn = document.getElementById("checkBtn");
const passwordSection = document.getElementById("passwordSection");
const passwordInput = document.getElementById("password");
const submitBtn = document.getElementById("submitBtn");
const message = document.getElementById("message");
const iframe = document.getElementById("authFrame");

let currentLogin = "";
let isNewUser = false;

// –°–ª—É—à–∞–µ–º postMessage –∏–∑ iframe
window.addEventListener("message", (e) => {
  if (e.data && e.data.type === "authResponse") {
    handleAuthResponse(e.data.data);
  }
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞
checkBtn.onclick = () => {
  const login = loginInput.value.trim();
  if (!login) return alert("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω");
  currentLogin = login;

  sendToIframe({ action: "checkLogin", login });
  message.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º...";
};

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª—è –∏–ª–∏ –≤—Ö–æ–¥
submitBtn.onclick = () => {
  const password = passwordInput.value.trim();
  if (!password) return alert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");

  const action = isNewUser ? "setPassword" : "login";
  sendToIframe({ action, login: currentLogin, password });
  message.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ iframe
function sendToIframe(payload) {
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write(`<form id="f" method="post" action="${AUTH_URL}"></form>`);
  doc.close();
  const f = doc.getElementById("f");

  for (const key in payload) {
    const input = doc.createElement("input");
    input.name = key;
    input.value = payload[key];
    f.appendChild(input);
  }

  f.submit();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
function handleAuthResponse(data) {
  if (data.error) {
    message.textContent = "–û—à–∏–±–∫–∞: " + data.error;
    return;
  }

  if (data.status) {
    if (data.status === "not_found") {
      message.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚ùå";
      passwordSection.style.display = "none";
    } else {
      isNewUser = data.status === "new_user";
      passwordSection.style.display = "block";
      submitBtn.textContent = isNewUser ? "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å" : "–í–æ–π—Ç–∏";
      message.textContent = isNewUser
        ? "–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ ‚Äî –ø—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å üîí"
        : "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å üîë";
    }
  } else if (data.success !== undefined) {
    if (data.success) {
      message.textContent = "‚úÖ –£—Å–ø–µ—à–Ω–æ";
      localStorage.setItem("login", currentLogin);
    } else {
      message.textContent =
        data.error === "wrong_password"
          ? "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"
          : data.error || "‚ö†Ô∏è –û—à–∏–±–∫–∞";
    }
  }
}
</script>
</body>
</html>
